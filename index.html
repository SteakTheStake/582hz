<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Focus Synth</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="icon" href="/favicon.ico" type="image/x-icon">

<!-- PWA meta + manifest -->
<meta name="theme-color" content="#5f7bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.webmanifest">
<!-- Optional, but recommended: create this icon file -->
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
    :root {
        --bg1: #e6f0ff;
        --bg2: #d6e3ff;
        --card-bg: #ffffff;
        --accent: #5f7bff;
        --accent-soft: #5f7bff40;
        --text-main: #1e2330;
        --text-soft: #606579;
        --brightness: 1;
        --contrast: 1;
        --glow-strength: 1; /* 0–2 */
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, var(--bg1), var(--bg2));
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px;
        color: var(--text-main);
        filter: brightness(var(--brightness)) contrast(var(--contrast));
        transition: background 0.3s ease, filter 0.2s ease;
    }

    .page {
        width: 100%;
        max-width: 1100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }

    h1 {
        margin: 4px 0 0;
        font-size: 1.5rem;
        text-align: center;
        letter-spacing: 0.03em;
    }

    .subtext {
        margin: 2px 0 8px;
        font-size: 0.9rem;
        text-align: center;
        color: var(--text-soft);
    }

    .transport-row {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    button {
        padding: 12px 32px;
        font-size: 1.05rem;
        border: none;
        border-radius: 999px;
        cursor: pointer;
        background: var(--accent);
        color: white;
        box-shadow:
            0 14px 32px rgba(0, 0, 0, calc(0.10 * var(--glow-strength))),
            0 0 0 1px rgba(255, 255, 255, 0.35);
        transition:
            background 0.2s ease,
            transform 0.1s ease,
            box-shadow 0.15s ease,
            filter 0.15s ease;
    }

    button:hover {
        background: #4f6af0;
        box-shadow:
            0 18px 40px rgba(0, 0, 0, calc(0.14 * var(--glow-strength))),
            0 0 0 1px rgba(255, 255, 255, 0.5);
        filter: brightness(1.03);
    }

    button:active {
        transform: translateY(1px);
        box-shadow:
            0 10px 20px rgba(0, 0, 0, calc(0.10 * var(--glow-strength)));
    }

    .transport-row small {
        font-size: 0.8rem;
        color: var(--text-soft);
        text-align: center;
    }

    .layout {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 16px;
    }

    .panel {
        background: radial-gradient(circle at top left, rgba(255,255,255,0.95), var(--card-bg));
        padding: 16px 16px 18px;
        border-radius: 22px;
        box-shadow:
            0 18px 40px rgba(15, 23, 42, calc(0.13 * var(--glow-strength))),
            0 0 0 1px rgba(255, 255, 255, 0.7);
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex: 1 1 280px;
        max-width: 360px;
        backdrop-filter: blur(16px);
    }

    .panel-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 4px;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: var(--text-soft);
    }

    .row {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        flex-wrap: nowrap;
    }

    .row label {
        font-size: 0.9rem;
        color: var(--text-soft);
        flex: 0 0 auto;
    }

    input[type=range] {
        flex: 1;
        accent-color: var(--accent);
        touch-action: pan-y;
    }

    select {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,0.06);
        font-size: 0.9rem;
        background: rgba(255,255,255,0.9);
    }

    input[type="text"] {
        flex: 1;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,0.12);
        font-size: 0.9rem;
        background: rgba(255,255,255,0.95);
    }

    .modes {
        display: flex;
        gap: 12px;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .modes input {
        accent-color: var(--accent);
    }

    .breathing-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-align: center;
        margin-top: 6px;
    }

    .breathing-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.85);
        box-shadow:
            0 18px 40px rgba(15, 23, 42, calc(0.16 * var(--glow-strength))),
            0 0 40px var(--accent-soft);
        animation: breathe 6s ease-in-out infinite;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.98), var(--accent-soft));
    }

    @keyframes breathe {
        0%   { transform: scale(0.82); opacity: 0.5; }
        50%  { transform: scale(1.08); opacity: 1; }
        100% { transform: scale(0.82); opacity: 0.5; }
    }

    .breathing-text {
        font-size: 0.85rem;
        color: var(--text-soft);
    }

    .theme-chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
    }

    .theme-chip {
        flex: 1 1 calc(33% - 4px);
        min-width: 72px;
        padding: 5px 8px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,0.06);
        font-size: 0.78rem;
        cursor: pointer;
        background: rgba(255,255,255,0.9);
        text-align: center;
        color: var(--text-soft);
        transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }

    .theme-chip.active {
        background: rgba(95, 123, 255, 0.1);
        box-shadow: 0 0 0 1px rgba(95,123,255,0.5);
        color: var(--text-main);
        transform: translateY(-1px);
    }

    .theme-chip:hover {
        background: rgba(255,255,255,1);
    }

    .small-label {
        font-size: 0.8rem;
        color: var(--text-soft);
    }

    .toggle-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--text-soft);
        margin-top: 4px;
    }

    .toggle-row input[type=checkbox] {
        accent-color: var(--accent);
    }

    /* Install banner */
    .hidden {
        display: none !important;
    }

    .install-banner {
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        max-width: 480px;
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.96);
        box-shadow:
            0 18px 40px rgba(15, 23, 42, 0.24),
            0 0 0 1px rgba(15, 23, 42, 0.06);
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 40;
        backdrop-filter: blur(16px);
        font-size: 0.85rem;
        color: var(--text-soft);
    }

    .install-banner strong {
        color: var(--text-main);
    }

    .install-banner button {
        padding: 6px 14px;
        font-size: 0.8rem;
        border-radius: 999px;
        white-space: nowrap;
    }

    .install-banner .install-actions {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .install-banner .install-close {
        background: transparent;
        color: var(--text-soft);
        box-shadow: none;
        padding: 4px 6px;
        min-width: auto;
    }

    /* ------- Mobile tweaks ------- */
    @media (max-width: 768px) {
        body {
            padding: 12px;
        }

        h1 {
            font-size: 1.35rem;
        }

        .transport-row {
            flex-direction: column;
            align-items: stretch;
        }

        #controlBtn {
            width: 100%;
        }

        .layout {
            flex-direction: column;
            align-items: stretch;
        }

        .panel {
            max-width: 100%;
        }

        .row {
            flex-direction: column;
            align-items: stretch;
        }

        .row label {
            width: 100%;
        }

        input[type=range] {
            width: 100%;
        }
    }

    @media (max-width: 480px) {
        button {
            padding: 10px 24px;
            font-size: 1rem;
        }

        .panel {
            padding: 14px 14px 16px;
            border-radius: 18px;
        }
    }
</style>
</head>
<body>

<!-- Install app banner -->
<div id="installBanner" class="install-banner hidden">
    <span id="installText">
        <strong>Install FM Focus?</strong> Use it like a mini app with better background playback.
    </span>
    <div class="install-actions">
        <button id="installBtn">Install</button>
        <button id="installClose" class="install-close" aria-label="Dismiss">✕</button>
    </div>
</div>

<div class="page">

    <h1>582 Hz FM Focus Synth</h1>
    <p class="subtext">Shape the sound and the atmosphere. Let it keep you company while you focus or wind down.</p>

    <div class="transport-row">
        <button id="controlBtn">Start</button>
        <small>
            <label>
                <input type="checkbox" id="backgroundToggle" checked>
                Keep playing in background (if browser allows)
            </label>
        </small>
    </div>

    <div class="layout">
        <!-- MAIN SYNTH PANEL -->
        <div class="panel">
            <div class="panel-title">Tone & FM</div>

            <div class="row">
                <label>
                    <input type="checkbox" id="toneEnabled" checked>
                    Enable tone
                </label>
            </div>

            <div class="row">
                <label for="volumeSlider">Master Volume: <span id="volLabel">70%</span></label>
                <input type="range" id="volumeSlider" min="0" max="100" value="70">
            </div>

            <div class="row">
                <label for="toneLevelSlider">Tone Level: <span id="toneLevelLabel">80%</span></label>
                <input type="range" id="toneLevelSlider" min="0" max="100" value="80">
            </div>

            <div class="row">
                <label for="waveform">Waveform:</label>
                <select id="waveform">
                    <option value="sine">Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>

            <div class="row">
                <label>Mode:</label>
                <div class="modes">
                    <label>
                        <input type="radio" name="mode" value="mono" checked> Mono
                    </label>
                    <label>
                        <input type="radio" name="mode" value="poly"> Poly
                    </label>
                </div>
            </div>

            <div class="row">
                <label for="modFreq">Mod Freq: <span id="modFreqLabel">584 Hz</span></label>
                <input type="range" id="modFreq" min="0" max="2000" value="584">
            </div>
            <div class="row">
                <label for="modDepth">FM Depth: <span id="modDepthLabel">65</span></label>
                <input type="range" id="modDepth" min="0" max="300" value="65">
            </div>
        </div>

        <!-- NOISE & AMBIENCE PANEL -->
        <div class="panel">
            <div class="panel-title">Noise & Ambience</div>

            <div class="row">
                <label>
                    <input type="checkbox" id="noiseEnabled" checked>
                    Enable noise
                </label>
            </div>

            <div class="row">
                <label for="noiseType">Noise type:</label>
                <select id="noiseType">
                    <option value="white_soft">White — soft</option>
                    <option value="white_bright">White — bright</option>
                    <option value="pink_warm" selected>Pink — warm</option>
                    <option value="pink_airy">Pink — airy</option>
                    <option value="brown_soft">Brown — soft rumble</option>
                    <option value="brown_deep">Brown — deep rumble</option>
                </select>
            </div>

            <div class="row">
                <label for="noiseLevel">Noise level: <span id="noiseLevelLabel">100%</span></label>
                <input type="range" id="noiseLevel" min="0" max="100" value="100">
            </div>

            <div class="row">
                <label for="noiseLowCut">Noise low cut: <span id="noiseLowCutLabel">100 Hz</span></label>
                <input type="range" id="noiseLowCut" min="20" max="2000" value="100">
            </div>

            <div class="row">
                <label for="noiseHighCut">Noise high cut: <span id="noiseHighCutLabel">8000 Hz</span></label>
                <input type="range" id="noiseHighCut" min="200" max="20000" value="8000">
            </div>

            <hr style="border:none;border-top:1px solid rgba(15,23,42,0.06);margin:6px 0;">

            <div class="small-label">Ambience loops</div>

            <div class="row">
                <label>
                    <input type="checkbox" id="birdsForestEnabled">
                    Birds in forest
                </label>
                <input type="range" id="birdsForestLevel" min="0" max="100" value="60">
                <span id="birdsForestLevelLabel" class="small-label">60%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="childrenAudienceEnabled">
                    Children audience talking
                </label>
                <input type="range" id="childrenAudienceLevel" min="0" max="100" value="50">
                <span id="childrenAudienceLevelLabel" class="small-label">50%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="forestAmbienceEnabled">
                    Forest ambience
                </label>
                <input type="range" id="forestAmbienceLevel" min="0" max="100" value="55">
                <span id="forestAmbienceLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="forestHeavyRainEnabled">
                    Forest heavy rain
                </label>
                <input type="range" id="forestHeavyRainLevel" min="0" max="100" value="65">
                <span id="forestHeavyRainLevelLabel" class="small-label">65%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="lightRainEnabled">
                    Light rain
                </label>
                <input type="range" id="lightRainLevel" min="0" max="100" value="60">
                <span id="lightRainLevelLabel" class="small-label">60%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="jungleRainBirdsEnabled">
                    Jungle rain &amp; birds
                </label>
                <input type="range" id="jungleRainBirdsLevel" min="0" max="100" value="60">
                <span id="jungleRainBirdsLevelLabel" class="small-label">60%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="strongWindEnabled">
                    Strong wind
                </label>
                <input type="range" id="strongWindLevel" min="0" max="100" value="55">
                <span id="strongWindLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="summerCricketsEnabled">
                    Summer night crickets
                </label>
                <input type="range" id="summerCricketsLevel" min="0" max="100" value="55">
                <span id="summerCricketsLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="thunderstormRainEnabled">
                    Thunderstorm &amp; rain
                </label>
                <input type="range" id="thunderstormRainLevel" min="0" max="100" value="65">
                <span id="thunderstormRainLevelLabel" class="small-label">65%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="crowdedPubEnabled">
                    Very crowded pub / party
                </label>
                <input type="range" id="crowdedPubLevel" min="0" max="100" value="55">
                <span id="crowdedPubLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="subwayCrowdEnabled">
                    Walking crowd (subway)
                </label>
                <input type="range" id="subwayCrowdLevel" min="0" max="100" value="55">
                <span id="subwayCrowdLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="windForestEnabled">
                    Wind in the forest
                </label>
                <input type="range" id="windForestLevel" min="0" max="100" value="55">
                <span id="windForestLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="windySeaEnabled">
                    Windy sea
                </label>
                <input type="range" id="windySeaLevel" min="0" max="100" value="55">
                <span id="windySeaLevelLabel" class="small-label">55%</span>
            </div>

            <div class="row">
                <label>
                    <input type="checkbox" id="winterWindEnabled">
                    Winter wind
                </label>
                <input type="range" id="winterWindLevel" min="0" max="100" value="55">
                <span id="winterWindLevelLabel" class="small-label">55%</span>
            </div>


            <div class="breathing-wrapper">
                <div class="breathing-circle"></div>
                <div class="breathing-text">
                    Inhale as the circle grows.<br>
                    Exhale as it softens.
                </div>
            </div>
        </div>

        <!-- APPEARANCE & PRESETS PANEL -->
        <div class="panel">
            <div class="panel-title">Display & Mood</div>

            <div class="small-label">Color presets</div>
            <div class="theme-chip-row" id="themeChips">
                <div class="theme-chip" data-color="blue" data-shade="medium">Blue</div>
                <div class="theme-chip" data-color="mint" data-shade="medium">Mint</div>
                <div class="theme-chip" data-color="lavender" data-shade="medium">Lavender</div>
                <div class="theme-chip" data-color="peach" data-shade="medium">Peach</div>
                <div class="theme-chip" data-color="slate" data-shade="medium">Slate</div>
            </div>

            <div class="row">
                <label for="shadeSelect">Shade:</label>
                <select id="shadeSelect">
                    <option value="light">Light</option>
                    <option value="medium" selected>Medium</option>
                    <option value="dark">Dark</option>
                </select>
            </div>

            <div class="row">
                <label for="brightnessSlider">Brightness: <span id="brightnessLabel">100%</span></label>
                <input type="range" id="brightnessSlider" min="70" max="130" value="100">
            </div>

            <div class="row">
                <label for="contrastSlider">Contrast: <span id="contrastLabel">100%</span></label>
                <input type="range" id="contrastSlider" min="80" max="120" value="100">
            </div>

            <div class="row">
                <label for="glowSlider">Glow: <span id="glowLabel">100%</span></label>
                <input type="range" id="glowSlider" min="40" max="160" value="100">
            </div>

            <div class="toggle-row">
                <input type="checkbox" id="rememberToggle" checked>
                <span>Remember these display settings</span>
            </div>

            <hr style="border:none;border-top:1px solid rgba(15,23,42,0.06);margin:6px 0;">

            <div class="panel-title" style="margin-top:0;">Presets</div>

            <div class="row">
                <label for="builtinPresetSelect">Built-in:</label>
                <select id="builtinPresetSelect">
                    <option value="">Select preset…</option>
                    <option value="deep_focus">Deep Focus</option>
                    <option value="rainy_cafe">Rainy Café</option>
                    <option value="fireplace_night">Fireplace Night</option>
                    <option value="windy_cliff">Windy Cliff</option>
                </select>
            </div>

            <div class="row">
                <label for="userPresetSelect">Your presets:</label>
                <select id="userPresetSelect">
                    <option value="">None saved yet</option>
                </select>
            </div>

            <div class="row">
                <label for="userPresetName">Preset name:</label>
                <input type="text" id="userPresetName" placeholder="e.g. Night Rain + Brown">
            </div>

            <div class="row">
                <button id="savePresetBtn" style="flex:1;">Save preset</button>
                <button id="deletePresetBtn" style="flex:1;">Delete selected</button>
            </div>

            <p class="small-label">
                Presets remember tone, noise, ambience, and display settings on this device.
            </p>
        </div>
    </div>
</div>

<script>
    // ---------- Cookie helpers ----------
    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
    }

    function getCookie(name) {
        const cname = name + "=";
        const decoded = decodeURIComponent(document.cookie || "");
        const parts = decoded.split(";");
        for (let c of parts) {
            c = c.trim();
            if (c.indexOf(cname) === 0) return c.substring(cname.length);
        }
        return null;
    }

    // ---------- Audio state ----------
    let audioCtx = null;
    let masterGain = null;
    let toneGain = null;
    let playing = false;
    let voices = [];

    // Noise chain
    let noiseSource = null;
    let noiseColorFilter = null;
    let noiseHPFilter = null;
    let noiseLPFilter = null;
    let noiseGain = null;

    // Ambience loops (from ./loops/ogg/*.ogg)
    const AMBIENCE_SOURCES = {
        birdsForest: "./loops/ogg/birds-in-forest-loop.ogg",
        childrenAudience: "./loops/ogg/children-audience-talking-loop.ogg",
        forestAmbience: "./loops/ogg/forest-ambience-loop.ogg",
        forestHeavyRain: "./loops/ogg/forest-heavy-rain-loop.ogg",
        lightRain: "./loops/ogg/light-rain-loop.ogg",
        jungleRainBirds: "./loops/ogg/rain-in-the-jungle-and-birds.ogg",
        strongWind: "./loops/ogg/strong-wind-loop.ogg",
        summerCrickets: "./loops/ogg/summer-night-crickets-loop.ogg",
        thunderstormRain: "./loops/ogg/thunderstorm-and-rain-loop.ogg",
        crowdedPub: "./loops/ogg/very-crowded-pub-or-party-loop.ogg",
        subwayCrowd: "./loops/ogg/walking-crowd-at-subway-station-loop.ogg",
        windForest: "./loops/ogg/wind-in-the-forest-loop.ogg",
        windySea: "./loops/ogg/windy-sea-loop.ogg",
        winterWind: "./loops/ogg/winter-wind-loop.ogg"
    };

    let ambienceBuffers = {}; // key -> AudioBuffer
    let ambienceNodes = {};
    Object.keys(AMBIENCE_SOURCES).forEach(key => {
        ambienceNodes[key] = { gain: null, source: null };
    });


    // UI elements
    const btn = document.getElementById("controlBtn");
    const backgroundToggle = document.getElementById("backgroundToggle");
    const rememberToggle = document.getElementById("rememberToggle");

    const toneEnabledCheckbox = document.getElementById("toneEnabled");
    const volumeSlider = document.getElementById("volumeSlider");
    const volLabel = document.getElementById("volLabel");
    const toneLevelSlider = document.getElementById("toneLevelSlider");
    const toneLevelLabel = document.getElementById("toneLevelLabel");
    const waveformSelect = document.getElementById("waveform");
    const modFreqSlider = document.getElementById("modFreq");
    const modFreqLabel = document.getElementById("modFreqLabel");
    const modDepthSlider = document.getElementById("modDepth");
    const modDepthLabel = document.getElementById("modDepthLabel");
    const modeRadios = document.querySelectorAll("input[name='mode']");

    const noiseEnabledCheckbox = document.getElementById("noiseEnabled");
    const noiseTypeSelect = document.getElementById("noiseType");
    const noiseLevelSlider = document.getElementById("noiseLevel");
    const noiseLevelLabel = document.getElementById("noiseLevelLabel");
    const noiseLowCutSlider = document.getElementById("noiseLowCut");
    const noiseLowCutLabel = document.getElementById("noiseLowCutLabel");
    const noiseHighCutSlider = document.getElementById("noiseHighCut");
    const noiseHighCutLabel = document.getElementById("noiseHighCutLabel");

    // Ambience UI controls (checkbox + slider + label for each loop)
    const ambienceControls = {
        birdsForest: {
            checkbox: document.getElementById("birdsForestEnabled"),
            slider: document.getElementById("birdsForestLevel"),
            label: document.getElementById("birdsForestLevelLabel")
        },
        childrenAudience: {
            checkbox: document.getElementById("childrenAudienceEnabled"),
            slider: document.getElementById("childrenAudienceLevel"),
            label: document.getElementById("childrenAudienceLevelLabel")
        },
        forestAmbience: {
            checkbox: document.getElementById("forestAmbienceEnabled"),
            slider: document.getElementById("forestAmbienceLevel"),
            label: document.getElementById("forestAmbienceLevelLabel")
        },
        forestHeavyRain: {
            checkbox: document.getElementById("forestHeavyRainEnabled"),
            slider: document.getElementById("forestHeavyRainLevel"),
            label: document.getElementById("forestHeavyRainLevelLabel")
        },
        lightRain: {
            checkbox: document.getElementById("lightRainEnabled"),
            slider: document.getElementById("lightRainLevel"),
            label: document.getElementById("lightRainLevelLabel")
        },
        jungleRainBirds: {
            checkbox: document.getElementById("jungleRainBirdsEnabled"),
            slider: document.getElementById("jungleRainBirdsLevel"),
            label: document.getElementById("jungleRainBirdsLevelLabel")
        },
        strongWind: {
            checkbox: document.getElementById("strongWindEnabled"),
            slider: document.getElementById("strongWindLevel"),
            label: document.getElementById("strongWindLevelLabel")
        },
        summerCrickets: {
            checkbox: document.getElementById("summerCricketsEnabled"),
            slider: document.getElementById("summerCricketsLevel"),
            label: document.getElementById("summerCricketsLevelLabel")
        },
        thunderstormRain: {
            checkbox: document.getElementById("thunderstormRainEnabled"),
            slider: document.getElementById("thunderstormRainLevel"),
            label: document.getElementById("thunderstormRainLevelLabel")
        },
        crowdedPub: {
            checkbox: document.getElementById("crowdedPubEnabled"),
            slider: document.getElementById("crowdedPubLevel"),
            label: document.getElementById("crowdedPubLevelLabel")
        },
        subwayCrowd: {
            checkbox: document.getElementById("subwayCrowdEnabled"),
            slider: document.getElementById("subwayCrowdLevel"),
            label: document.getElementById("subwayCrowdLevelLabel")
        },
        windForest: {
            checkbox: document.getElementById("windForestEnabled"),
            slider: document.getElementById("windForestLevel"),
            label: document.getElementById("windForestLevelLabel")
        },
        windySea: {
            checkbox: document.getElementById("windySeaEnabled"),
            slider: document.getElementById("windySeaLevel"),
            label: document.getElementById("windySeaLevelLabel")
        },
        winterWind: {
            checkbox: document.getElementById("winterWindEnabled"),
            slider: document.getElementById("winterWindLevel"),
            label: document.getElementById("winterWindLevelLabel")
        }
    };


    const brightnessSlider = document.getElementById("brightnessSlider");
    const brightnessLabel = document.getElementById("brightnessLabel");
    const contrastSlider = document.getElementById("contrastSlider");
    const contrastLabel = document.getElementById("contrastLabel");
    const glowSlider = document.getElementById("glowSlider");
    const glowLabel = document.getElementById("glowLabel");
    const themeChipsContainer = document.getElementById("themeChips");
    const shadeSelect = document.getElementById("shadeSelect");

    const builtinPresetSelect = document.getElementById("builtinPresetSelect");
    const userPresetSelect = document.getElementById("userPresetSelect");
    const userPresetNameInput = document.getElementById("userPresetName");
    const savePresetBtn = document.getElementById("savePresetBtn");
    const deletePresetBtn = document.getElementById("deletePresetBtn");

    const installBanner = document.getElementById("installBanner");
    const installBtn = document.getElementById("installBtn");
    const installClose = document.getElementById("installClose");
    const installText = document.getElementById("installText");
    let deferredInstallPrompt = null;

    // Initial labels
    modFreqLabel.textContent = modFreqSlider.value + " Hz";
    modDepthLabel.textContent = modDepthSlider.value;
    noiseLevelLabel.textContent = noiseLevelSlider.value + "%";
    noiseLowCutLabel.textContent = noiseLowCutSlider.value + " Hz";
    noiseHighCutLabel.textContent = noiseHighCutSlider.value + " Hz";
    brightnessLabel.textContent = brightnessSlider.value + "%";
    contrastLabel.textContent = contrastSlider.value + "%";
    glowLabel.textContent = glowSlider.value + "%";
    Object.values(ambienceControls).forEach(ctrl => {
        ctrl.label.textContent = ctrl.slider.value + "%";
    });


    // ---------- Theme presets ----------
    const themePresets = {
        blue: {
            light:  { bg1:"#edf3ff", bg2:"#dce7ff", accent:"#5f7bff" },
            medium: { bg1:"#e6f0ff", bg2:"#d6e3ff", accent:"#5f7bff" },
            dark:   { bg1:"#ced7f7", bg2:"#b8c5f0", accent:"#4c63df" }
        },
        mint: {
            light:  { bg1:"#e7f8f2", bg2:"#d2f0e4", accent:"#46c7a4" },
            medium: { bg1:"#def5ee", bg2:"#c8ecdf", accent:"#3fb999" },
            dark:   { bg1:"#c4e5d8", bg2:"#add7c9", accent:"#329a80" }
        },
        lavender: {
            light:  { bg1:"#f1ecff", bg2:"#e3dbff", accent:"#9a7dff" },
            medium: { bg1:"#ebe4ff", bg2:"#ddd3ff", accent:"#8f72f3" },
            dark:   { bg1:"#d7ccfa", bg2:"#c1b3f0", accent:"#795ad7" }
        },
        peach: {
            light:  { bg1:"#ffece3", bg2:"#ffd8c7", accent:"#ff8a5c" },
            medium: { bg1:"#ffe3d6", bg2:"#ffd0bf", accent:"#ff7a4b" },
            dark:   { bg1:"#f7c8b1", bg2:"#f2b39a", accent:"#e86437" }
        },
        slate: {
            light:  { bg1:"#e3edf5", bg2:"#d0dde9", accent:"#4b6b9b" },
            medium: { bg1:"#dde7f2", bg2:"#c5d3e3", accent:"#425c87" },
            dark:   { bg1:"#c5d0dd", bg2:"#afbccc", accent:"#364b70" }
        }
    };

    let currentThemeColor = "blue";
    let currentThemeShade = "medium";

    function applyTheme(color, shade) {
        const preset = themePresets[color][shade];
        if (!preset) return;
        const root = document.documentElement;
        root.style.setProperty("--bg1", preset.bg1);
        root.style.setProperty("--bg2", preset.bg2);
        root.style.setProperty("--accent", preset.accent);
        root.style.setProperty("--accent-soft", preset.accent + "40");

        currentThemeColor = color;
        currentThemeShade = shade;

        document.querySelectorAll(".theme-chip").forEach(chip => {
            const c = chip.getAttribute("data-color");
            chip.classList.toggle("active", c === color);
        });

        if (rememberToggle.checked) {
            setCookie("focus_theme_color", color, 365);
            setCookie("focus_theme_shade", shade, 365);
        }
    }

    // ---------- Volume curve ----------
    function sliderToGain(value) {
        const x = value / 100;
        const min = 0.0001;
        return min * Math.pow(1 / min, x);
    }

    // ---------- Noise settings ----------
    function applyNoiseColorSettings() {
        if (!noiseColorFilter) return;
        const type = noiseTypeSelect.value;
        // Base white noise, we shape it using biquads
        switch (type) {
            case "white_soft":
                noiseColorFilter.type = "lowpass";
                noiseColorFilter.frequency.value = 8000;
                noiseColorFilter.Q.value = 0.7;
                break;
            case "white_bright":
                noiseColorFilter.type = "highpass";
                noiseColorFilter.frequency.value = 500;
                noiseColorFilter.Q.value = 0.7;
                break;
            case "pink_warm":
                noiseColorFilter.type = "lowpass";
                noiseColorFilter.frequency.value = 4000;
                noiseColorFilter.Q.value = 0.9;
                break;
            case "pink_airy":
                noiseColorFilter.type = "peaking";
                noiseColorFilter.frequency.value = 4000;
                noiseColorFilter.gain.value = 3;
                noiseColorFilter.Q.value = 0.8;
                break;
            case "brown_soft":
                noiseColorFilter.type = "lowpass";
                noiseColorFilter.frequency.value = 800;
                noiseColorFilter.Q.value = 0.7;
                break;
            case "brown_deep":
                noiseColorFilter.type = "lowpass";
                noiseColorFilter.frequency.value = 400;
                noiseColorFilter.Q.value = 0.9;
                break;
            default:
                noiseColorFilter.type = "allpass";
                noiseColorFilter.frequency.value = 1000;
                noiseColorFilter.Q.value = 1;
        }
    }

    function applyNoiseEQSettings() {
        if (noiseHPFilter) {
            noiseHPFilter.type = "highpass";
            noiseHPFilter.frequency.value = parseFloat(noiseLowCutSlider.value);
            noiseHPFilter.Q.value = 0.707;
        }
        if (noiseLPFilter) {
            noiseLPFilter.type = "lowpass";
            noiseLPFilter.frequency.value = parseFloat(noiseHighCutSlider.value);
            noiseLPFilter.Q.value = 0.707;
        }
    }

    // ---------- Ambience helpers ----------
    function loadAmbienceBuffer(key) {
        if (!audioCtx || ambienceBuffers[key] || !AMBIENCE_SOURCES[key]) return;
        fetch(AMBIENCE_SOURCES[key])
            .then(res => res.arrayBuffer())
            .then(data => new Promise((resolve, reject) => {
                audioCtx.decodeAudioData(data, resolve, reject);
            }))
            .then(buffer => {
                ambienceBuffers[key] = buffer;
                if (playing && ambienceControls[key]?.checkbox.checked) {
                    startAmbienceSource(key);
                }
            })
            .catch(err => console.error("Error loading ambience", key, err));
    }

    function startAmbienceSource(key) {
        if (!audioCtx || !masterGain) return;
        const buffer = ambienceBuffers[key];
        if (!buffer) {
            loadAmbienceBuffer(key);
            return;
        }
        const node = ambienceNodes[key];
        if (!node.gain) {
            node.gain = audioCtx.createGain();
            node.gain.connect(masterGain);
        }
        if (node.source) {
            try { node.source.stop(); } catch(e) {}
            node.source.disconnect();
        }
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        src.loop = true;
        src.connect(node.gain);
        src.start();
        node.source = src;
        updateAmbienceGain(key);
    }

    function stopAllAmbience() {
        Object.keys(ambienceNodes).forEach(key => {
            const node = ambienceNodes[key];
            if (node.source) {
                try { node.source.stop(); } catch(e) {}
                node.source.disconnect();
                node.source = null;
            }
            if (node.gain) {
                node.gain.disconnect();
                node.gain = null;
            }
        });
    }

    function updateAmbienceGain(key) {
        const node = ambienceNodes[key];
        const ctrl = ambienceControls[key];
        if (!node || !node.gain || !ctrl) return;

        if (!ctrl.checkbox.checked) {
            node.gain.gain.value = 0;
        } else {
            node.gain.gain.value = sliderToGain(ctrl.slider.value) * 0.6;
        }
    }


    // ---------- Tone ----------
    function clearToneVoices() {
        voices.forEach(v => {
            try { v.carrier.stop(); } catch(e) {}
            try { v.modOsc.stop(); } catch(e) {}
            v.carrier.disconnect();
            v.modOsc.disconnect();
            v.modGain.disconnect();
        });
        voices = [];
    }

    function buildToneVoices() {
        if (!audioCtx || !toneGain || !toneEnabledCheckbox.checked) {
            clearToneVoices();
            return;
        }

        clearToneVoices();

        const mode = document.querySelector("input[name='mode']:checked").value;
        const numVoices = mode === "poly" ? 3 : 1;
        const baseFreq = 582;
        const waveform = waveformSelect.value;
        const modFreq = parseFloat(modFreqSlider.value);
        const modDepth = parseFloat(modDepthSlider.value);

        for (let i = 0; i < numVoices; i++) {
            const carrier = audioCtx.createOscillator();
            carrier.type = waveform;

            let detune = 0;
            if (mode === "poly") {
                if (i === 1) detune = -4;
                if (i === 2) detune = +4;
            }
            carrier.frequency.value = baseFreq + detune;

            const modOsc = audioCtx.createOscillator();
            modOsc.type = "sine";
            modOsc.frequency.value = modFreq;

            const modGain = audioCtx.createGain();
            modGain.gain.value = modDepth;

            modOsc.connect(modGain);
            modGain.connect(carrier.frequency);

            carrier.connect(toneGain);

            carrier.start();
            modOsc.start();

            voices.push({ carrier, modOsc, modGain });
        }
    }

    function startAudio() {
        // PWA/mobile-friendly AudioContext creation
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)({
                latencyHint: "interactive"
            });
        }
        if (audioCtx.state === "suspended") {
            audioCtx.resume();
        }

        masterGain = audioCtx.createGain();
        masterGain.gain.value = sliderToGain(volumeSlider.value);
        masterGain.connect(audioCtx.destination);

        toneGain = audioCtx.createGain();
        const initialToneGain = toneEnabledCheckbox.checked
            ? sliderToGain(toneLevelSlider.value)
            : 0;
        toneGain.gain.value = initialToneGain;
        toneGain.connect(masterGain);

        buildToneVoices();

        const bufferSize = audioCtx.sampleRate * 2;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.random() * 2 - 1;
        }

        noiseSource = audioCtx.createBufferSource();
        noiseSource.buffer = buffer;
        noiseSource.loop = true;

        noiseColorFilter = audioCtx.createBiquadFilter();
        noiseHPFilter = audioCtx.createBiquadFilter();
        noiseLPFilter = audioCtx.createBiquadFilter();
        noiseGain = audioCtx.createGain();

        applyNoiseColorSettings();
        applyNoiseEQSettings();

        const initialNoiseGain = noiseEnabledCheckbox.checked
            ? sliderToGain(noiseLevelSlider.value) * 0.6
            : 0.0;
        noiseGain.gain.value = initialNoiseGain;

        noiseSource.connect(noiseColorFilter);
        noiseColorFilter.connect(noiseHPFilter);
        noiseHPFilter.connect(noiseLPFilter);
        noiseLPFilter.connect(noiseGain);
        noiseGain.connect(masterGain);

        noiseSource.start();

        // Ambience graph
        Object.keys(AMBIENCE_SOURCES).forEach(key => {
            if (!ambienceNodes[key]) ambienceNodes[key] = { gain: null, source: null };
            const node = ambienceNodes[key];
            if (!node.gain) {
                node.gain = audioCtx.createGain();
                node.gain.connect(masterGain);
            }
            const ctrl = ambienceControls[key];
            updateAmbienceGain(key);
            if (ctrl && ctrl.checkbox.checked) {
                if (ambienceBuffers[key]) {
                    startAmbienceSource(key);
                } else {
                    loadAmbienceBuffer(key);
                }
            }
        });


        playing = true;
        btn.textContent = "Stop";
    }

    function stopAudio() {
        clearToneVoices();

        if (noiseSource) {
            try { noiseSource.stop(); } catch(e) {}
            noiseSource.disconnect();
            noiseSource = null;
        }
        if (noiseColorFilter) {
            noiseColorFilter.disconnect();
            noiseColorFilter = null;
        }
        if (noiseHPFilter) {
            noiseHPFilter.disconnect();
            noiseHPFilter = null;
        }
        if (noiseLPFilter) {
            noiseLPFilter.disconnect();
            noiseLPFilter = null;
        }
        if (noiseGain) {
            noiseGain.disconnect();
            noiseGain = null;
        }

        stopAllAmbience();

        if (toneGain) {
            toneGain.disconnect();
            toneGain = null;
        }

        if (masterGain) {
            masterGain.disconnect();
            masterGain = null;
        }
        if (audioCtx) {
            audioCtx.close();
            audioCtx = null;
        }

        playing = false;
        btn.textContent = "Start";
    }

    // ---------- Event wiring ----------
    btn.addEventListener("click", () => {
        if (!playing) startAudio(); else stopAudio();
    });

    volumeSlider.addEventListener("input", () => {
        volLabel.textContent = volumeSlider.value + "%";
        if (masterGain) masterGain.gain.value = sliderToGain(volumeSlider.value);
    });

    toneLevelSlider.addEventListener("input", () => {
        toneLevelLabel.textContent = toneLevelSlider.value + "%";
        if (toneGain) {
            toneGain.gain.value = toneEnabledCheckbox.checked
                ? sliderToGain(toneLevelSlider.value)
                : 0;
        }
    });

    toneEnabledCheckbox.addEventListener("change", () => {
        const enabled = toneEnabledCheckbox.checked;
        if (toneGain) {
            toneGain.gain.value = enabled ? sliderToGain(toneLevelSlider.value) : 0;
        }
        if (!playing) return;
        if (enabled) {
            buildToneVoices();
        } else {
            clearToneVoices();
        }
    });

    waveformSelect.addEventListener("change", () => {
        if (!playing) return;
        const waveform = waveformSelect.value;
        voices.forEach(v => v.carrier.type = waveform);
    });

    modeRadios.forEach(radio => {
        radio.addEventListener("change", () => {
            if (playing) {
                stopAudio();
                startAudio();
            }
        });
    });

    modFreqSlider.addEventListener("input", () => {
        const val = parseFloat(modFreqSlider.value);
        modFreqLabel.textContent = val + " Hz";
        if (!playing) return;
        voices.forEach(v => v.modOsc.frequency.value = val);
    });

    modDepthSlider.addEventListener("input", () => {
        const val = parseFloat(modDepthSlider.value);
        modDepthLabel.textContent = val;
        if (!playing) return;
        voices.forEach(v => v.modGain.gain.value = val);
    });

    noiseEnabledCheckbox.addEventListener("change", () => {
        if (!playing || !noiseGain) return;
        if (noiseEnabledCheckbox.checked) {
            noiseGain.gain.value = sliderToGain(noiseLevelSlider.value) * 1.25;
        } else {
            noiseGain.gain.value = 0;
        }
    });

    noiseTypeSelect.addEventListener("change", () => {
        if (!playing) return;
        applyNoiseColorSettings();
    });

    noiseLevelSlider.addEventListener("input", () => {
        noiseLevelLabel.textContent = noiseLevelSlider.value + "%";
        if (!playing || !noiseGain) return;
        if (noiseEnabledCheckbox.checked) {
            noiseGain.gain.value = sliderToGain(noiseLevelSlider.value) * 1.25;
        }
    });

    noiseLowCutSlider.addEventListener("input", () => {
        noiseLowCutLabel.textContent = noiseLowCutSlider.value + " Hz";
        if (!playing) return;
        applyNoiseEQSettings();
    });

    noiseHighCutSlider.addEventListener("input", () => {
        noiseHighCutLabel.textContent = noiseHighCutSlider.value + " Hz";
        if (!playing) return;
        applyNoiseEQSettings();
    });

    // Ambience UI events (generic)
    Object.entries(ambienceControls).forEach(([key, ctrl]) => {
        ctrl.slider.addEventListener("input", () => {
            ctrl.label.textContent = ctrl.slider.value + "%";
            if (!playing) return;
            updateAmbienceGain(key);
        });

        ctrl.checkbox.addEventListener("change", () => {
            if (!playing) return;
            if (ctrl.checkbox.checked) {
                startAmbienceSource(key);
            } else {
                updateAmbienceGain(key);
            }
        });
    });


    rainLevelSlider.addEventListener("input", () =>
        ambienceSliderHandler("rain", rainLevelLabel, rainLevelSlider));
    windLevelSlider.addEventListener("input", () =>
        ambienceSliderHandler("wind", windLevelLabel, windLevelSlider));
    fireplaceLevelSlider.addEventListener("input", () =>
        ambienceSliderHandler("fireplace", fireplaceLevelLabel, fireplaceLevelSlider));
    coffeeshopLevelSlider.addEventListener("input", () =>
        ambienceSliderHandler("coffeeshop", coffeeshopLevelLabel, coffeeshopLevelSlider));

    rainEnabledCheckbox.addEventListener("change", () => {
        if (!playing) return;
        if (rainEnabledCheckbox.checked) {
            startAmbienceSource("rain");
        }
        updateAmbienceGain("rain");
    });

    windEnabledCheckbox.addEventListener("change", () => {
        if (!playing) return;
        if (windEnabledCheckbox.checked) {
            startAmbienceSource("wind");
        }
        updateAmbienceGain("wind");
    });

    fireplaceEnabledCheckbox.addEventListener("change", () => {
        if (!playing) return;
        if (fireplaceEnabledCheckbox.checked) {
            startAmbienceSource("fireplace");
        }
        updateAmbienceGain("fireplace");
    });

    coffeeshopEnabledCheckbox.addEventListener("change", () => {
        if (!playing) return;
        if (coffeeshopEnabledCheckbox.checked) {
            startAmbienceSource("coffeeshop");
        }
        updateAmbienceGain("coffeeshop");
    });

    // Display controls
    brightnessSlider.addEventListener("input", () => {
        const val = parseInt(brightnessSlider.value, 10);
        brightnessLabel.textContent = val + "%";
        document.documentElement.style.setProperty("--brightness", (val / 100).toString());
        if (rememberToggle.checked) setCookie("focus_brightness", val, 365);
    });

    contrastSlider.addEventListener("input", () => {
        const val = parseInt(contrastSlider.value, 10);
        contrastLabel.textContent = val + "%";
        document.documentElement.style.setProperty("--contrast", (val / 100).toString());
        if (rememberToggle.checked) setCookie("focus_contrast", val, 365);
    });

    glowSlider.addEventListener("input", () => {
        const val = parseInt(glowSlider.value, 10);
        glowLabel.textContent = val + "%";
        document.documentElement.style.setProperty("--glow-strength", (val / 100).toString());
        if (rememberToggle.checked) setCookie("focus_glow", val, 365);
    });

    themeChipsContainer.addEventListener("click", (e) => {
        const chip = e.target.closest(".theme-chip");
        if (!chip) return;
        const color = chip.getAttribute("data-color");
        const shade = shadeSelect.value;
        applyTheme(color, shade);
        if (rememberToggle.checked) {
            setCookie("focus_theme_color", color, 365);
            setCookie("focus_theme_shade", shade, 365);
        }
    });

    shadeSelect.addEventListener("change", () => {
        applyTheme(currentThemeColor, shadeSelect.value);
        if (rememberToggle.checked) {
            setCookie("focus_theme_shade", shadeSelect.value, 365);
        }
    });

    backgroundToggle.addEventListener("change", () => {
        if (rememberToggle.checked) {
            setCookie("focus_background", backgroundToggle.checked ? "1" : "0", 365);
        }
    });

    // visibility: DO NOT auto-stop on hide; just resume if needed
    document.addEventListener("visibilitychange", () => {
        if (audioCtx && audioCtx.state === "suspended") {
            audioCtx.resume();
        }
    });

    // ---------- Restore from cookies ----------
    (function restoreSettingsFromCookies() {
        const cColor = getCookie("focus_theme_color");
        const cShade = getCookie("focus_theme_shade");
        const cBright = getCookie("focus_brightness");
        const cContrast = getCookie("focus_contrast");
        const cGlow = getCookie("focus_glow");
        const cBackground = getCookie("focus_background");

        if (cColor && themePresets[cColor]) currentThemeColor = cColor;
        if (cShade && themePresets[currentThemeColor][cShade]) currentThemeShade = cShade;

        shadeSelect.value = currentThemeShade;
        applyTheme(currentThemeColor, currentThemeShade);

        if (cBright) {
            brightnessSlider.value = cBright;
            brightnessLabel.textContent = cBright + "%";
            document.documentElement.style.setProperty("--brightness", (cBright / 100).toString());
        }
        if (cContrast) {
            contrastSlider.value = cContrast;
            contrastLabel.textContent = cContrast + "%";
            document.documentElement.style.setProperty("--contrast", (cContrast / 100).toString());
        }
        if (cGlow) {
            glowSlider.value = cGlow;
            glowLabel.textContent = cGlow + "%";
            document.documentElement.style.setProperty("--glow-strength", (cGlow / 100).toString());
        }
        if (cBackground !== null) {
            backgroundToggle.checked = cBackground === "1";
        }
    })();

    // ---------- Background audio keep-alive loop ----------
    setInterval(() => {
        if (audioCtx && audioCtx.state === "suspended") {
            audioCtx.resume();
        }
    }, 1000);

    // ---------- Presets ----------
    const USER_PRESETS_KEY = "focus_user_presets_v1";

    const builtInPresets = {
        deep_focus: {
            toneEnabled: true,
            volume: 70,
            toneLevel: 80,
            waveform: "sine",
            mode: "mono",
            modFreq: 584,
            modDepth: 50,
            noiseEnabled: true,
            noiseType: "brown_soft",
            noiseLevel: 70,
            noiseLowCut: 80,
            noiseHighCut: 6000,
            rainEnabled: false,
            rainLevel: 50,
            windEnabled: false,
            windLevel: 40,
            fireplaceEnabled: false,
            fireplaceLevel: 50,
            coffeeshopEnabled: false,
            coffeeshopLevel: 60,
            themeColor: "blue",
            themeShade: "medium",
            brightness: 100,
            contrast: 100,
            glow: 100
        },
        rainy_cafe: {
            toneEnabled: false,
            volume: 80,
            toneLevel: 0,
            waveform: "sine",
            mode: "mono",
            modFreq: 500,
            modDepth: 20,
            noiseEnabled: true,
            noiseType: "pink_warm",
            noiseLevel: 65,
            noiseLowCut: 120,
            noiseHighCut: 7000,
            rainEnabled: true,
            rainLevel: 75,
            windEnabled: false,
            windLevel: 40,
            fireplaceEnabled: false,
            fireplaceLevel: 40,
            coffeeshopEnabled: true,
            coffeeshopLevel: 70,
            themeColor: "peach",
            themeShade: "light",
            brightness: 100,
            contrast: 100,
            glow: 120
        },
        fireplace_night: {
            toneEnabled: false,
            volume: 60,
            toneLevel: 0,
            waveform: "triangle",
            mode: "mono",
            modFreq: 300,
            modDepth: 10,
            noiseEnabled: true,
            noiseType: "brown_deep",
            noiseLevel: 55,
            noiseLowCut: 40,
            noiseHighCut: 4000,
            rainEnabled: false,
            rainLevel: 50,
            windEnabled: false,
            windLevel: 30,
            fireplaceEnabled: true,
            fireplaceLevel: 80,
            coffeeshopEnabled: false,
            coffeeshopLevel: 60,
            themeColor: "lavender",
            themeShade: "dark",
            brightness: 90,
            contrast: 110,
            glow: 130
        },
        windy_cliff: {
            toneEnabled: true,
            volume: 75,
            toneLevel: 60,
            waveform: "triangle",
            mode: "poly",
            modFreq: 900,
            modDepth: 80,
            noiseEnabled: true,
            noiseType: "white_soft",
            noiseLevel: 50,
            noiseLowCut: 300,
            noiseHighCut: 9000,
            rainEnabled: false,
            rainLevel: 50,
            windEnabled: true,
            windLevel: 85,
            fireplaceEnabled: false,
            fireplaceLevel: 40,
            coffeeshopEnabled: false,
            coffeeshopLevel: 40,
            themeColor: "slate",
            themeShade: "medium",
            brightness: 100,
            contrast: 105,
            glow: 110
        }
    };

    function getUserPresets() {
        try {
            const raw = localStorage.getItem(USER_PRESETS_KEY);
            if (!raw) return {};
            return JSON.parse(raw) || {};
        } catch {
            return {};
        }
    }

    function saveUserPresets(map) {
        try {
            localStorage.setItem(USER_PRESETS_KEY, JSON.stringify(map));
        } catch {}
    }

    function refreshUserPresetSelect() {
        const presets = getUserPresets();
        userPresetSelect.innerHTML = "";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = Object.keys(presets).length ? "Select preset…" : "None saved yet";
        userPresetSelect.appendChild(defaultOpt);

        Object.keys(presets).sort().forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            userPresetSelect.appendChild(opt);
        });
    }

    function collectCurrentSettings() {
        const settings = {
            toneEnabled: toneEnabledCheckbox.checked,
            volume: parseInt(volumeSlider.value, 10),
            toneLevel: parseInt(toneLevelSlider.value, 10),
            waveform: waveformSelect.value,
            mode: document.querySelector("input[name='mode']:checked").value,
            modFreq: parseInt(modFreqSlider.value, 10),
            modDepth: parseInt(modDepthSlider.value, 10),
            noiseEnabled: noiseEnabledCheckbox.checked,
            noiseType: noiseTypeSelect.value,
            noiseLevel: parseInt(noiseLevelSlider.value, 10),
            noiseLowCut: parseInt(noiseLowCutSlider.value, 10),
            noiseHighCut: parseInt(noiseHighCutSlider.value, 10),
            themeColor: currentThemeColor,
            themeShade: currentThemeShade,
            brightness: parseInt(brightnessSlider.value, 10),
            contrast: parseInt(contrastSlider.value, 10),
            glow: parseInt(glowSlider.value, 10)
        };

        // add ambience fields
        Object.entries(ambienceControls).forEach(([key, ctrl]) => {
            settings[`${key}Enabled`] = ctrl.checkbox.checked;
            settings[`${key}Level`] = parseInt(ctrl.slider.value, 10);
        });

        return settings;
    }


    function applyPreset(preset) {
        if (!preset) return;

        // Tone & master
        toneEnabledCheckbox.checked = preset.toneEnabled;
        volumeSlider.value = preset.volume;
        volLabel.textContent = preset.volume + "%";
        toneLevelSlider.value = preset.toneLevel;
        toneLevelLabel.textContent = preset.toneLevel + "%";
        waveformSelect.value = preset.waveform;
        const modeRadio = Array.from(modeRadios).find(r => r.value === preset.mode);
        if (modeRadio) modeRadio.checked = true;
        modFreqSlider.value = preset.modFreq;
        modFreqLabel.textContent = preset.modFreq + " Hz";
        modDepthSlider.value = preset.modDepth;
        modDepthLabel.textContent = preset.modDepth;

        // Noise
        noiseEnabledCheckbox.checked = preset.noiseEnabled;
        noiseTypeSelect.value = preset.noiseType;
        noiseLevelSlider.value = preset.noiseLevel;
        noiseLevelLabel.textContent = preset.noiseLevel + "%";
        noiseLowCutSlider.value = preset.noiseLowCut;
        noiseLowCutLabel.textContent = preset.noiseLowCut + " Hz";
        noiseHighCutSlider.value = preset.noiseHighCut;
        noiseHighCutLabel.textContent = preset.noiseHighCut + " Hz";

        // Display
        brightnessSlider.value = preset.brightness;
        brightnessLabel.textContent = preset.brightness + "%";
        contrastSlider.value = preset.contrast;
        contrastLabel.textContent = preset.contrast + "%";
        glowSlider.value = preset.glow;
        glowLabel.textContent = preset.glow + "%";
        shadeSelect.value = preset.themeShade;
        applyTheme(preset.themeColor, preset.themeShade);

        // Ambience from preset (if defined)
        Object.entries(ambienceControls).forEach(([key, ctrl]) => {
            const enabledField = `${key}Enabled`;
            const levelField = `${key}Level`;

            if (enabledField in preset) {
                ctrl.checkbox.checked = !!preset[enabledField];
            } else {
                ctrl.checkbox.checked = false;
            }

            if (levelField in preset) {
                const lvl = parseInt(preset[levelField], 10);
                if (!Number.isNaN(lvl)) {
                    ctrl.slider.value = lvl;
                }
            }
            ctrl.label.textContent = ctrl.slider.value + "%";
        });

        if (playing) {
            // Re-apply audio side
            volumeSlider.dispatchEvent(new Event("input"));
            toneLevelSlider.dispatchEvent(new Event("input"));
            toneEnabledCheckbox.dispatchEvent(new Event("change"));
            modFreqSlider.dispatchEvent(new Event("input"));
            modDepthSlider.dispatchEvent(new Event("input"));
            noiseTypeSelect.dispatchEvent(new Event("change"));
            noiseLevelSlider.dispatchEvent(new Event("input"));
            noiseLowCutSlider.dispatchEvent(new Event("input"));
            noiseHighCutSlider.dispatchEvent(new Event("input"));

            Object.keys(ambienceControls).forEach(key => {
                const ctrl = ambienceControls[key];
                if (ctrl.checkbox.checked) {
                    startAmbienceSource(key);
                } else {
                    updateAmbienceGain(key);
                }
            });
        } else {
            // At least update the visual display settings
            brightnessSlider.dispatchEvent(new Event("input"));
            contrastSlider.dispatchEvent(new Event("input"));
            glowSlider.dispatchEvent(new Event("input"));
        }
    }


    builtinPresetSelect.addEventListener("change", () => {
        const key = builtinPresetSelect.value;
        if (!key) return;
        const preset = builtInPresets[key];
        applyPreset(preset);
    });

    savePresetBtn.addEventListener("click", () => {
        const name = (userPresetNameInput.value || "").trim();
        if (!name) return;
        const presets = getUserPresets();
        presets[name] = collectCurrentSettings();
        saveUserPresets(presets);
        refreshUserPresetSelect();
        userPresetSelect.value = name;
    });

    deletePresetBtn.addEventListener("click", () => {
        const selected = userPresetSelect.value;
        if (!selected) return;
        const presets = getUserPresets();
        if (presets[selected]) {
            delete presets[selected];
            saveUserPresets(presets);
            refreshUserPresetSelect();
        }
    });

    userPresetSelect.addEventListener("change", () => {
        const name = userPresetSelect.value;
        if (!name) return;
        const presets = getUserPresets();
        applyPreset(presets[name]);
    });

    refreshUserPresetSelect();

    // ---------- PWA install prompt ----------
    window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
        installBanner.classList.remove("hidden");
    });

    installBtn.addEventListener("click", async () => {
        if (!deferredInstallPrompt) return;
        deferredInstallPrompt.prompt();
        const choice = await deferredInstallPrompt.userChoice;
        deferredInstallPrompt = null;
        if (rememberToggle && rememberToggle.checked) {
            setCookie("focus_install_outcome", choice.outcome || "", 365);
        }
        installBanner.classList.add("hidden");
    });

    installClose.addEventListener("click", () => {
        installBanner.classList.add("hidden");
        if (rememberToggle && rememberToggle.checked) {
            setCookie("focus_install_dismissed", "1", 365);
        }
    });

    function isIos() {
        return /iphone|ipad|ipod/i.test(window.navigator.userAgent);
    }

    function isStandalone() {
        const iosStandalone = window.navigator.standalone === true;
        const displayModeStandalone = window.matchMedia('(display-mode: standalone)').matches;
        return iosStandalone || displayModeStandalone;
    }

    window.addEventListener("load", () => {
        const dismissed = getCookie("focus_install_dismissed") === "1";
        if (isIos() && !isStandalone() && !dismissed) {
            installText.innerHTML =
                "<strong>Install FM Focus?</strong> On iPhone: tap the share icon ▢↑ and choose <em>Add to Home Screen</em>.";
            if (installBtn) {
                installBtn.style.display = "none";
            }
            installBanner.classList.remove("hidden");
        }
    });

    // ---------- Service worker registration ----------
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("./sw.js").catch((err) => {
                console.error("SW registration failed:", err);
            });
        });
    }
</script>

</body>
</html>
